<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anime viewer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            cursor: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        #mediaPlayer, #mediaImage {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #mediaPlayer {
            object-fit: cover;
        }
    </style>
</head>
<body>

    <video id="mediaPlayer" autoplay muted playsinline preload="auto"></video>
    <img id="mediaImage">

    <script>
        const mediaPlayer = document.getElementById('mediaPlayer');
        const mediaImage = document.getElementById('mediaImage');

        let mediaFiles = [];
        let currentIndex = 0;
        let imageTimer = null;
        let playAttemptInterval = null;
        let preloadedMedia = [];
        const PRELOAD_COUNT = 2;

        function setupMedia(files) {
            mediaFiles = files;
            if (mediaFiles.length > 0) {
                preloadNextMedia(PRELOAD_COUNT);
                playNextMedia();
            } else {
                console.warn("no media provided.");
            }
        }

        function preloadNextMedia(count) {
            preloadedMedia = [];
            for (let i = 0; i < count; i++) {
                const nextIndex = (currentIndex + 1 + i) % mediaFiles.length;
                const file = mediaFiles[nextIndex];
                const fileExtension = file.split('.').pop().toLowerCase();

                if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
                    const videoElement = document.createElement('video');
                    videoElement.src = file;
                    videoElement.preload = 'auto';
                    videoElement.muted = true;
                    videoElement.playsInline = true;
                    videoElement.style.display = 'none';
                    document.body.appendChild(videoElement);
                    preloadedMedia.push(videoElement);
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                    const imageElement = new Image();
                    imageElement.src = file;
                    imageElement.style.display = 'none';
                    document.body.appendChild(imageElement);
                    preloadedMedia.push(imageElement);
                }
            }
        }

        function playNextMedia() {
            if (imageTimer) {
                clearTimeout(imageTimer);
                imageTimer = null;
            }

            if (playAttemptInterval) {
                clearInterval(playAttemptInterval);
                playAttemptInterval = null;
            }

            if (mediaFiles.length === 0) {
                console.warn("no media to play.");
                return;
            }

            if (currentIndex >= mediaFiles.length) {
                currentIndex = 0;
            }

            const file = mediaFiles[currentIndex];
            const fileExtension = file.split('.').pop().toLowerCase();

            mediaPlayer.style.opacity = 0;
            mediaImage.style.opacity = 0;

            setTimeout(() => {
                if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
                    mediaPlayer.src = file;
                    mediaPlayer.style.display = 'block';
                    mediaImage.style.display = 'none';

                    const attemptPlay = () => {
                        mediaPlayer.play()
                            .then(() => {
                                console.log("playing:", file);
                                if (playAttemptInterval) {
                                    clearInterval(playAttemptInterval);
                                    playAttemptInterval = null;
                                }
                                mediaPlayer.style.opacity = 1;
                            })
                            .catch(error => {
                                console.error("video playback error:", file, error);
                            });
                    };

                    attemptPlay();
                    playAttemptInterval = setInterval(attemptPlay, 3000);

                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                    mediaImage.src = file;
                    mediaImage.style.display = 'block';
                    mediaPlayer.style.display = 'none';

                    mediaImage.onload = () => {
                        mediaImage.style.opacity = 1;
                        imageTimer = setTimeout(() => {
                            currentIndex++;
                            playNextMedia();
                        }, 10000);
                    };
                    mediaImage.onerror = () => {
                        console.error("image error:", file);
                        currentIndex++;
                        playNextMedia();
                    };
                } else {
                    console.warn("nah wtf is this file, skip:", file);
                    currentIndex++;
                    playNextMedia();
                }

                preloadNextMedia(PRELOAD_COUNT);
            }, 500);
        }

        mediaPlayer.onended = () => {
            console.log("next vid");
            currentIndex++;
            playNextMedia();
        };

        mediaPlayer.onerror = (e) => {
            console.error("media error:", e.message || e);
            currentIndex++;
            playNextMedia();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const elem = document.documentElement;

            function requestFullscreen() {
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        elem.msRequestFullscreen();
                    }
                }
            }

            requestFullscreen();

            document.body.addEventListener('click', requestFullscreen);
            document.addEventListener('keydown', requestFullscreen);

            setupMedia([
                'https://rare-gallery.com/livewalls/videostmp/74e1b2b16c84b17ac856d7785b12a5d8.mp4',
                'https://rare-gallery.com/uploads/posts/305736-Anime-Girl-Swimsuit-4K.jpg',
                'https://rare-gallery.com/livewalls/videostmp/ffd4b6cffa007420cc8dfed6f5ea514a.mp4',
                'https://rare-gallery.com/livewalls/videostmp/1db279c067bdeecf5bac076123a27c22.mp4',
                'https://rare-gallery.com/livewalls/videostmp/fae9cb53dcd6d29234be1b45210103f2.mp4',
                'https://rare-gallery.com/uploads/posts/303609-Azur-Lane-Kaga-Anime-Girl-Beach-Swimsuit-Bikini-4K.jpg',
                'https://rare-gallery.com/mocahbig/418912-anime-girls-Amashiro-Natsuki-artwork-animal-ears.jpg',
                'https://rare-gallery.com/livewalls/videostmp/7405fd317bd9aa52e60b177c37ba9092.mp4',
                'https://rare-gallery.com/livewalls/videostmp/65199d17abbdee3ba0b01e730dc6e967.mp4',
                'https://rare-gallery.com/livewalls/videostmp/cf2895842e2bf887397d5dbf5832c7ad.mp4',
                'https://rare-gallery.com/livewalls/videostmp/377b4b91acfc2f0b7a6f11980c29fa15.mp4',
                'https://rare-gallery.com/livewalls/videostmp/3cf88cd9af4d2f6dd3021b5953857d39.mp4',
                'https://rare-gallery.com/uploads/posts/4516192-short-hair-white-hair-white-background-aqua-eyes-bed-blushing-hair-bows-eromanga-sensei-izumi-sagiri-loli-shorts.jpg',
                'https://rare-gallery.com/livewalls/videostmp/10238d4bab573ed83c7054dc1cff7949.mp4',
                'https://rare-gallery.com/livewalls/videostmp/e0145b8e1e971ee6eef6882fe163ea29.mp4',
                'https://rare-gallery.com/livewalls/videostmp/6bb6c152d23864b9d5aec51a6fee479a.mp4',
            ]);
        });
    </script>

</body>
</html>
