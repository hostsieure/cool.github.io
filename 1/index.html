<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anime viewer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            cursor: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        #mediaPlayer, #mediaImage {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #mediaPlayer {
            object-fit: cover;
        }
    </style>
</head>
<body>
    <video id="mediaPlayer" autoplay muted playsinline preload="auto"></video>
    <img id="mediaImage">

    <script>
        const mediaPlayer = document.getElementById('mediaPlayer');
        const mediaImage = document.getElementById('mediaImage');

        let mediaFiles = [];
        let currentIndex = 0;
        let imageTimer = null;
        let playAttemptInterval = null;
        let preloadedMedia = [];
        let isPlaying = false;
        let eventListenersAdded = false;
        const PRELOAD_COUNT = 2;
        const IMAGE_DURATION = 10000;

        function setupMedia(files) {
            mediaFiles = files.filter(file => file && file.trim());
            if (mediaFiles.length > 0) {
                setupEventListeners();
                preloadNextMedia(PRELOAD_COUNT);
                playNextMedia();
            }
        }

        function setupEventListeners() {
            if (eventListenersAdded) return;
            
            mediaPlayer.removeEventListener('ended', handleVideoEnd);
            mediaPlayer.removeEventListener('error', handleVideoError);
            mediaPlayer.removeEventListener('loadeddata', handleVideoLoaded);
            mediaPlayer.removeEventListener('canplay', handleVideoCanPlay);
            
            mediaPlayer.addEventListener('ended', handleVideoEnd);
            mediaPlayer.addEventListener('error', handleVideoError);
            mediaPlayer.addEventListener('loadeddata', handleVideoLoaded);
            mediaPlayer.addEventListener('canplay', handleVideoCanPlay);
            
            eventListenersAdded = true;
        }

        function handleVideoEnd() {
            nextMedia();
        }

        function handleVideoError(e) {
            nextMedia();
        }

        function handleVideoLoaded() {
        }

        function handleVideoCanPlay() {
            if (!isPlaying) {
                attemptPlay();
            }
        }

        function cleanupTimers() {
            if (imageTimer) {
                clearTimeout(imageTimer);
                imageTimer = null;
            }
            if (playAttemptInterval) {
                clearInterval(playAttemptInterval);
                playAttemptInterval = null;
            }
        }

        function cleanupPreloadedMedia() {
            preloadedMedia.forEach(el => {
                if (el && el.parentNode) {
                    el.removeEventListener('error', () => {});
                    el.parentNode.removeChild(el);
                }
            });
            preloadedMedia = [];
        }

        function preloadNextMedia(count) {
            cleanupPreloadedMedia();

            for (let i = 0; i < count && i < mediaFiles.length; i++) {
                const nextIndex = (currentIndex + 1 + i) % mediaFiles.length;
                const file = mediaFiles[nextIndex];
                const fileExtension = getFileExtension(file);

                if (isVideoFile(fileExtension)) {
                    const videoElement = document.createElement('video');
                    videoElement.src = file;
                    videoElement.preload = 'metadata';
                    videoElement.muted = true;
                    videoElement.playsInline = true;
                    videoElement.style.display = 'none';
                    videoElement.addEventListener('error', () => {});
                    document.body.appendChild(videoElement);
                    preloadedMedia.push(videoElement);
                } else if (isImageFile(fileExtension)) {
                    const imageElement = new Image();
                    imageElement.src = file;
                    imageElement.style.display = 'none';
                    imageElement.addEventListener('error', () => {});
                    document.body.appendChild(imageElement);
                    preloadedMedia.push(imageElement);
                }
            }
        }

        function getFileExtension(file) {
            return file.split('.').pop().toLowerCase().split('?')[0];
        }

        function isVideoFile(extension) {
            return ['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(extension);
        }

        function isImageFile(extension) {
            return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension);
        }

        function nextMedia() {
            currentIndex = (currentIndex + 1) % mediaFiles.length;
            playNextMedia();
        }

        function attemptPlay() {
            if (mediaPlayer.readyState >= 2) {
                mediaPlayer.play()
                    .then(() => {
                        isPlaying = true;
                        cleanupTimers();
                        mediaPlayer.style.opacity = 1;
                    })
                    .catch(error => {
                        setTimeout(() => {
                            if (!isPlaying) {
                                nextMedia();
                            }
                        }, 3000);
                    });
            }
        }

        function playNextMedia() {
            cleanupTimers();
            isPlaying = false;

            if (mediaFiles.length === 0) {
                return;
            }

            if (currentIndex >= mediaFiles.length) {
                currentIndex = 0;
            }

            const file = mediaFiles[currentIndex];
            if (!file) {
                nextMedia();
                return;
            }

            const fileExtension = getFileExtension(file);

            mediaPlayer.style.opacity = 0;
            mediaImage.style.opacity = 0;

            setTimeout(() => {
                if (isVideoFile(fileExtension)) {
                    playVideo(file);
                } else if (isImageFile(fileExtension)) {
                    playImage(file);
                } else {
                    nextMedia();
                }
            }, 500);
        }

        function playVideo(file) {
            mediaPlayer.pause();
            mediaPlayer.src = '';
            mediaPlayer.load();
            
            mediaPlayer.src = file;
            mediaPlayer.style.display = 'block';
            mediaImage.style.display = 'none';

            const checkReady = () => {
                if (mediaPlayer.readyState >= 2) {
                    attemptPlay();
                } else {
                    setTimeout(checkReady, 100);
                }
            };

            mediaPlayer.load();
            setTimeout(checkReady, 100);

            setTimeout(() => {
                if (!isPlaying) {
                    attemptPlay();
                }
            }, 3000);

            setTimeout(() => {
                if (!isPlaying) {
                    nextMedia();
                }
            }, 10000);

            preloadNextMedia(PRELOAD_COUNT);
        }

        function playImage(file) {
            mediaImage.src = file;
            mediaImage.style.display = 'block';
            mediaPlayer.style.display = 'none';
            mediaPlayer.pause();

            const imageLoadTimeout = setTimeout(() => {
                nextMedia();
            }, 5000);

            mediaImage.onload = () => {
                clearTimeout(imageLoadTimeout);
                mediaImage.style.opacity = 1;
                
                imageTimer = setTimeout(() => {
                    nextMedia();
                }, IMAGE_DURATION);
            };

            mediaImage.onerror = () => {
                clearTimeout(imageLoadTimeout);
                nextMedia();
            };

            preloadNextMedia(PRELOAD_COUNT);
        }

        function requestFullscreen() {
            const elem = document.documentElement;
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => {
                        console.error("Fullscreen request failed:", err);
                    });
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen().catch(err => {
                        console.error("Fullscreen request (webkit) failed:", err);
                    });
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen().catch(err => {
                        console.error("Fullscreen request (ms) failed:", err);
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', requestFullscreen, { once: true });
            document.addEventListener('keydown', requestFullscreen, { once: true });

            setupMedia([
                'https://rare-gallery.com/livewalls/videostmp/74e1b2b16c84b17ac856d7785b12a5d8.mp4',
                'https://rare-gallery.com/uploads/posts/305736-Anime-Girl-Swimsuit-4K.jpg',
                'https://rare-gallery.com/livewalls/videostmp/ffd4b6cffa007420cc8dfed6f5ea514a.mp4',
                'https://rare-gallery.com/livewalls/videostmp/1db279c067bdeecf5bac076123a27c22.mp4',
                'https://rare-gallery.com/livewalls/videostmp/fae9cb53dcd6d29234be1b45210103f2.mp4',
                'https://rare-gallery.com/uploads/posts/303609-Azur-Lane-Kaga-Anime-Girl-Beach-Swimsuit-Bikini-4K.jpg',
                'https://rare-gallery.com/mocahbig/418912-anime-girls-Amashiro-Natsuki-artwork-animal-ears.jpg',
                'https://rare-gallery.com/livewalls/videostmp/7405fd317bd9aa52e60b177c37ba9092.mp4',
                'https://rare-gallery.com/livewalls/videostmp/65199d17abbdee3ba0b01e730dc6e967.mp4',
                'https://rare-gallery.com/livewalls/videostmp/cf2895842e2bf887397d5dbf5832c7ad.mp4',
                'https://rare-gallery.com/livewalls/videostmp/377b4b91acfc2f0b7a6f11980c29fa15.mp4',
                'https://rare-gallery.com/livewalls/videostmp/3cf88cd9af4d2f6dd3021b5953857d39.mp4',
                'https://rare-gallery.com/uploads/posts/4516192-short-hair-white-hair-white-background-aqua-eyes-bed-blushing-hair-bows-eromanga-sensei-izumi-sagiri-loli-shorts.jpg',
                'https://rare-gallery.com/livewalls/videostmp/10238d4bab573ed83c7054dc1cff7949.mp4',
                'https://rare-gallery.com/livewalls/videostmp/e0145b8e1e971ee6eef6882fe163ea29.mp4',
                'https://rare-gallery.com/livewalls/videostmp/6bb6c152d23864b9d5aec51a6fee479a.mp4'
            ]);
        });

        window.addEventListener('beforeunload', () => {
            cleanupTimers();
            cleanupPreloadedMedia();
        });
    </script>
</body>
</html>
